<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Bazaar Stocks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="stylesheet" href="http://localhost:5555/stylesheets/home.css">

    <!--
    READ:

    haha fooled ya get punked

    also if you want to know how to import assets, scripts, or stylesheets:
    look at app.js
    -->

    <script>
      const IN_DEVELOPMENT = true;
    </script>
  </head>
  <body>
    <div class="top-bar">
      <div>
        <button class="btn"> > </button>
      </div>
    </div>
    <div>
      <div class="scroll-news" id="stocks" style="height: 660px;">
        <div class="active-news">
          <p style="font-weight: normal;">Hypixel News</p>
          <p class="stock-desc">From hypixel.net</p>
          <p class="mrkt-cap" id="mrkt-cap-title" style="background-color: #999999" onclick="switchMode()">--</p>
        </div>
      </div>
      <div class="scroll-info" id="info" style="height: 725px;">
        <h2><b>Recent Threads</b></h2>
        <br/>
        <br/>
        <div id="threads">
          <p>Loading...</p>
        </div>
      </div>
    </div>
    <!--Node.JS Scripts-->
    <script>
      var backendData = null;
      var ipcRenderer = require("electron").ipcRenderer;

      var storedFirstBackendData = false;

      ipcRenderer.on("data", (e, dt) => {
        backendData = dt;
        console.log("Recieved Keys.")
        onRecieveKeys(backendData);

        if (!storedFirstBackendData) {
          console.log("Recieved First Backend Data. Stored in `storage[" + storage.length + "]`");
          storage.push(dt);
          storedFirstBackendData = true;
        }
      })
    </script>
    <script>
      //links
      const sbForums = "https://hypixel.net/forums"
      var generalDiscussion = sbForums + "/skyblock-general-discussion.157/";
      var patchNotes = sbForums + "/skyblock-patch-notes.158/";
      var guides = sbForums + "/guides-and-strategies.162/";

      var greenImageSrc = "http://localhost:5555/assets/greensquare.png";

      //packages
      const axios = require("axios");
      const $ = require("cheerio");

      var threadsElement = document.getElementById("threads");

      var storage = [];

      var storedFirstGeneralDiscussion = false;

      // var userData = {
      //   username: null,
      //   triedSaving: false
      // }

      function getGeneralDiscussion() {
        //get the general discussion
        axios.get(generalDiscussion)
          .then((data) => {
            //This is just for testing, I use this with axios in console to figure out how to find certain elements and stuff
            if (!storedFirstGeneralDiscussion) {
              console.log("Recieved First General Discussion Data. Stored in `storage[" + storage.length + "]`");
              storage.push(data);
              storedFirstGeneralDiscussion = true;
            }

            threadsElement.innerHTML = "";

            if (data.status !== 200) {
              throw "There was an error getting the data, returned status code " + data.status + " from " + generalDiscussion + ".";
            }

            let html = data.data;

            //This shouldn't work btw. If it does, idk what happened lol
            // if (!userData.triedSaving) {
            //   let userObj = $(".p-navgroup-link--user > span", html);
            //
            //   if (userObj.length != 0) {
            //     //That means that they are signed in.
            //     console.log("User is signed in, saving their username. Also stored the obj in `storage[" + storage.length + "]`")
            //     storage.push(userObj)
            //
            //     let username = userObj.children[1].data;
            //
            //     userData.username = username;
            //   } else {
            //     console.log("User doesn't seem to be logged in.")
            //   }
            //
            //   userData.triedSaving = true;
            // }

            let threads = $(".structItem--thread", html);

            for (let i = 0; i < threads.length; i++) {
              let threadTitle = $(".structItem-cell--main > .structItem-title", threads[i])[0].children[1].children[0].data;
              let imageLink = $(".structItem-cell--icon > .structItem-iconContainer", threads[i])[0].children[1].children[1].attribs.src;

              let divEle = document.createElement("div");

              divEle.classList.add("news-thread");

              let imageEle = document.createElement("img");

              //Change the image from a small to a large, or just use green cause they have no avatar.
              imageEle.src = (imageLink != null) ? imageLink.replace("/s/", "/l/") : greenImageSrc;

              imageEle.height = 200;
              imageEle.width = 200;

              let textEle = document.createElement("h4");

              textEle.textContent = threadTitle;

              divEle.appendChild(imageEle);
              divEle.appendChild(textEle);

              threadsElement.appendChild(divEle);
              threadsElement.appendChild(document.createElement("br"))

              if (i % 2 != 0) {
                divEle.classList.add("news-thread-right-side");
              } else {
                divEle.classList.add("news-thread-left-side");
              }

              divEle.onclick = () => alert("this will bring you to thread or smth")
            }
          })
          .catch((err) => {
            threadsElement.innerHTML = "<p style=\"color: red;\">There was an error loading content from <a href=\"https://hypixel.net\">https://hypixel.net</a>.</p>";

            if (IN_DEVELOPMENT) {
              threadsElement.innerHTML += "<br/><p style=\"color: white;\">Stack Trace: </p><br/><p style=\"color: red;\">" + err.stack + "</p>";
            }
            throw err;
          });
      }

      getGeneralDiscussion();

      const REFRESH_RATE = 60; //This is in seconds.

      setInterval(() => {
        console.log("Refreshing Recent Threads...");
        getGeneralDiscussion();
      }, REFRESH_RATE * 1000);

    </script>
    <!--Normal JS Scripts-->
    <script src="http://localhost:5555/scripts/home.js"></script>
  </body>
</html>
